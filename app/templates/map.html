{% extends "base.html" %}

{% block title %}{{ _('Газрын зураг') }} - {{ _('Шатахуун хянагч') }}{% endblock %}

{% block content %}
<h2>{{ _('Тээврийн хэрэгслийн байршлын зураг') }}</h2>

<div id="map" style="height:500px; width:100%; margin-top:20px;"></div>

<div style="margin-top: 16px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div><strong>{{ _('Нийт зай') }}:</strong> <span id="stat-distance">0</span> км</div>
    <div><strong>{{ _('Хөдлөх хугацаа') }}:</strong> <span id="stat-moving">0</span> мин</div>
    <div><strong>{{ _('Зогсох хугацаа') }}:</strong> <span id="stat-idle">0</span> мин</div>
    <div><strong>{{ _('Хөдөлгөөнд зарцуулсан шатахуун') }}:</strong> <span id="stat-fuel-moving">0</span> Л</div>
    <div><strong>{{ _('Зогсолтод зарцуулсан шатахуун') }}:</strong> <span id="stat-fuel-idle">0</span> Л</div>
    <div><strong>{{ _('Нийт зарцуулсан шатахуун') }}:</strong> <span id="stat-fuel-total">0</span> Л</div>
    <div><strong>{{ _('Зогсолтын зарцуулалт (л/ц, сүүлийн интервал)') }}:</strong> <span id="stat-idle-lph">-</span></div>
  </div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    var map = L.map('map').setView([34.34, 108.94], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    var marker = L.marker([34.34, 108.94]).addTo(map);
    var path = L.polyline([], { color: 'blue', weight: 4 }).addTo(map);

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(function (pos) {
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;

            // Update marker
            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 14);

            // Append to polyline
            path.addLatLng([lat, lon]);

            // Send data to backend
            fetch("/api/location", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ lat: lat, lon: lon, timestamp: new Date().toISOString() })
            })
            .then(res => res.json())
            .then(data => console.log("Saved:", data));
        });
    }

    // Load existing path on load
    fetch('/api/location?limit=1000')
        .then(r => r.json())
        .then(points => {
            if (points && points.length) {
                var latlngs = points.map(p => [p.lat, p.lon]);
                path.setLatLngs(latlngs);
                var last = latlngs[latlngs.length - 1];
                marker.setLatLng(last);
                map.setView(last, 14);
            }
        });

    function refreshStats() {
        fetch('/api/trips/stats')
            .then(r => r.json())
            .then(s => {
                document.getElementById('stat-distance').textContent = s.total_distance_km;
                document.getElementById('stat-moving').textContent = s.moving_time_minutes;
                document.getElementById('stat-idle').textContent = s.idle_time_minutes;
                document.getElementById('stat-fuel-moving').textContent = s.moving_fuel_liters;
                document.getElementById('stat-fuel-idle').textContent = s.idle_fuel_liters;
                document.getElementById('stat-fuel-total').textContent = s.total_fuel_liters;
            });
    }

    refreshStats();
    setInterval(refreshStats, 10000);

    function refreshMotorHour() {
        fetch('/api/motor_hour')
            .then(r => r.json())
            .then(s => {
                if (s && s.idle_liters_per_hour !== undefined && s.idle_liters_per_hour !== null) {
                    document.getElementById('stat-idle-lph').textContent = s.idle_liters_per_hour;
                }
            })
            .catch(() => {});
    }
    refreshMotorHour();
    setInterval(refreshMotorHour, 30000);
</script>

{% endblock %}
