{% extends "base.html" %}

{% block title %}{{ _('–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥') }} - {{ _('–®–∞—Ç–∞—Ö—É—É–Ω —Ö—è–Ω–∞–≥—á') }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="text-center mb-6">
        <h2 class="text-3xl font-bold text-foreground mb-2">üó∫Ô∏è {{ _('–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ & –ó–∞–π —Ö—è–Ω–∞–ª—Ç') }}</h2>
        <p class="text-muted-foreground">{{ _('GPS-–∞–∞—Ä –±–∞–π—Ä—à–∏–ª —Ö—è–Ω–∞–∂, –∑–∞–π –±–æ–ª–æ–Ω —à–∞—Ç–∞—Ö—É—É–Ω—ã –∑–∞—Ä—Ü—É—É–ª–∞–ª—Ç—ã–≥ —Ç–æ–æ—Ü–æ–æ–ª–Ω–æ') }}</p>
    </div>

    <!-- Map Controls -->
    <div class="bg-card border border-border rounded-lg p-4 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center space-x-4">
                <button id="start-tracking" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    {{ _('–•—è–Ω–∞–ª—Ç —ç—Ö–ª“Ø“Ø–ª—ç—Ö') }}
                </button>
                <button id="stop-tracking" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition-colors hidden">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    {{ _('–•—è–Ω–∞–ª—Ç –∑–æ–≥—Å–æ–æ—Ö') }}
                </button>
                <button id="clear-path" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition-colors">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H9a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    {{ _('–ó–∞–º —Ü—ç–≤—ç—Ä–ª—ç—Ö') }}
                </button>
            </div>
            
            <div class="flex items-center space-x-4">
                <label class="text-sm font-medium text-foreground">{{ _('–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–≥–∏–π–Ω —Ç”©—Ä”©–ª:') }}</label>
                <select id="map-type" class="px-3 py-2 border border-border rounded-md bg-input-background text-foreground">
                    <option value="osm">{{ _('OpenStreetMap') }}</option>
                    <option value="satellite">{{ _('–°–∞–Ω—Å—Ä—ã–Ω –∑—É—Ä–∞–≥') }}</option>
                    <option value="terrain">{{ _('–ì–∞–¥–∞—Ä–≥–∞') }}</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="bg-card border border-border rounded-lg p-4 mb-6">
        <div id="map" class="h-96 w-full rounded-lg"></div>
    </div>

    <!-- Trip Information -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Current Trip Stats -->
        <div class="bg-card border border-border rounded-lg p-6">
            <h3 class="text-lg font-semibold text-foreground mb-4">{{ _('–û–¥–æ–æ–≥–∏–π–Ω –∞—è–ª–∞–ª') }}</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-primary" id="current-distance">0.0</div>
                    <div class="text-sm text-muted-foreground">{{ _('–ó–∞–π (–∫–º)') }}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="current-duration">00:00</div>
                    <div class="text-sm text-muted-foreground">{{ _('–•—É–≥–∞—Ü–∞–∞') }}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="current-speed">0.0</div>
                    <div class="text-sm text-muted-foreground">{{ _('–•—É—Ä–¥ (–∫–º/—Ü)') }}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="current-fuel">0.0</div>
                    <div class="text-sm text-muted-foreground">{{ _('–®–∞—Ç–∞—Ö—É—É–Ω (–ª)') }}</div>
                </div>
            </div>
        </div>

        <!-- Overall Stats -->
        <div class="bg-card border border-border rounded-lg p-6">
            <h3 class="text-lg font-semibold text-foreground mb-4">{{ _('–ù–∏–π—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫') }}</h3>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-muted-foreground">{{ _('–ù–∏–π—Ç –∑–∞–π:') }}</span>
                    <span class="font-medium text-foreground" id="total-distance">0.0 –∫–º</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-muted-foreground">{{ _('–•”©–¥–ª”©—Ö —Ö—É–≥–∞—Ü–∞–∞:') }}</span>
                    <span class="font-medium text-foreground" id="total-moving">0 –º–∏–Ω</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-muted-foreground">{{ _('–ó–æ–≥—Å–æ—Ö —Ö—É–≥–∞—Ü–∞–∞:') }}</span>
                    <span class="font-medium text-foreground" id="total-idle">0 –º–∏–Ω</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-muted-foreground">{{ _('–ù–∏–π—Ç —à–∞—Ç–∞—Ö—É—É–Ω:') }}</span>
                    <span class="font-medium text-foreground" id="total-fuel">0.0 –õ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Input -->
    <div class="bg-card border border-border rounded-lg p-6">
        <h3 class="text-lg font-semibold text-foreground mb-4">{{ _('–ë–∞–π—Ä—à–∏–ª –æ—Ä—É—É–ª–∞—Ö') }}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-foreground mb-2">{{ _('”®—Ä–≥”©—Ä”©–≥ (Latitude)') }}</label>
                <input type="number" id="manual-lat" step="0.000001" class="w-full px-3 py-2 border border-border rounded-md bg-input-background text-foreground placeholder-muted-foreground">
            </div>
            <div>
                <label class="block text-sm font-medium text-foreground mb-2">{{ _('–£—Ä—Ç—Ä–∞–≥ (Longitude)') }}</label>
                <input type="number" id="manual-lon" step="0.000001" class="w-full px-3 py-2 border border-border rounded-md bg-input-background text-foreground placeholder-muted-foreground">
            </div>
        </div>
        <div class="mt-4">
            <button id="add-manual-point" class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90 transition-colors">
                {{ _('–ë–∞–π—Ä—à–∏–ª –Ω—ç–º—ç—Ö') }}
            </button>
        </div>
    </div>
</div>

<!-- Notification System -->
<div id="notification-container" class="fixed top-4 right-4 z-[3000] space-y-2"></div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
.leaflet-control-container { z-index: 1000; }
.leaflet-popup-content { color: #000; }
</style>

<script>
let map, marker, path, currentTrip;
let isTracking = false;
let tripStartTime, tripStartLocation;
let currentTripDistance = 0;
let currentTripDuration = 0;
let currentTripFuel = 0;

// Initialize map
function initMap() {
    map = L.map('map').setView([47.9184, 106.9177], 13); // Ulaanbaatar coordinates
    
    // Map layers
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
    });
    
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: '¬© Esri'
    });
    
    const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '¬© OpenTopoMap'
    });
    
    // Add default layer
    osmLayer.addTo(map);
    
    // Store layers for switching
    window.mapLayers = {
        osm: osmLayer,
        satellite: satelliteLayer,
        terrain: terrainLayer
    };
    
    // Initialize path and marker
    path = L.polyline([], { color: 'blue', weight: 4, opacity: 0.7 });
    marker = L.marker([47.9184, 106.9177]).addTo(map);
    
    // Add path to map
    path.addTo(map);
}

// Switch map layers
function switchMapLayer(layerType) {
    // Remove all layers
    Object.values(window.mapLayers).forEach(layer => {
        map.removeLayer(layer);
    });
    
    // Add selected layer
    window.mapLayers[layerType].addTo(map);
}

// Start tracking
function startTracking() {
    if (!navigator.geolocation) {
        alert('{{ _("–¢–∞–Ω—ã —Ç”©—Ö”©”©—Ä”©–º–∂ GPS-–¥ –¥—ç–º–∂–ª—ç–≥ “Ø–∑“Ø“Ø–ª–¥—ç–≥–≥“Ø–π") }}');
        return;
    }
    
    isTracking = true;
    tripStartTime = new Date();
    tripStartLocation = null;
    currentTripDistance = 0;
    currentTripDuration = 0;
    currentTripFuel = 0;
    
    document.getElementById('start-tracking').classList.add('hidden');
    document.getElementById('stop-tracking').classList.remove('hidden');
    
    // Start watching position
    window.watchId = navigator.geolocation.watchPosition(
        updatePosition,
        handleLocationError,
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
    );
    
    // Update timer
    window.tripTimer = setInterval(updateTripTimer, 1000);
}

// Stop tracking
function stopTracking() {
    isTracking = false;
    
    if (window.watchId) {
        navigator.geolocation.clearWatch(window.watchId);
    }
    
    if (window.tripTimer) {
        clearInterval(window.tripTimer);
    }
    
    document.getElementById('start-tracking').classList.remove('hidden');
    document.getElementById('stop-tracking').classList.add('hidden');
    
    // Save trip data
    if (currentTripDistance > 0) {
        saveTripData();
    }
}

// Update position
function updatePosition(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const accuracy = position.coords.accuracy;
    
    // Update marker
    marker.setLatLng([lat, lon]);
    
    // Center map on first position
    if (!tripStartLocation) {
        tripStartLocation = [lat, lon];
        map.setView([lat, lon], 15);
    }
    
    // Add to path
    path.addLatLng([lat, lon]);
    
    // Calculate distance if we have a previous point
    if (path.getLatLngs().length > 1) {
        const points = path.getLatLngs();
        const prevPoint = points[points.length - 2];
        const distance = prevPoint.distanceTo([lat, lon]) / 1000; // Convert to km
        currentTripDistance += distance;
        
        // Update current trip stats
        updateCurrentTripStats();
    }
    
    // Send to backend
    saveLocation(lat, lon, accuracy);
}

// Handle location errors
function handleLocationError(error) {
    console.error('Location error:', error);
    let message = '{{ _("–ë–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞") }}';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            message = '{{ _("–ë–∞–π—Ä—à–ª—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ç–∞—Ç–≥–∞–ª–∑–∞–≥–¥—Å–∞–Ω") }}';
            break;
        case error.POSITION_UNAVAILABLE:
            message = '{{ _("–ë–∞–π—Ä—à–ª—ã–Ω –º—ç–¥—ç—ç–ª—ç–ª –±–æ–ª–æ–º–∂–≥“Ø–π") }}';
            break;
        case error.TIMEOUT:
            message = '{{ _("–ë–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö —Ö—É–≥–∞—Ü–∞–∞ —Ö—ç—Ç—ç—Ä—Å—ç–Ω") }}';
            break;
    }
    
    alert(message);
}

// Update current trip timer
function updateTripTimer() {
    if (tripStartTime) {
        const now = new Date();
        currentTripDuration = Math.floor((now - tripStartTime) / 1000);
        
        const minutes = Math.floor(currentTripDuration / 60);
        const seconds = currentTripDuration % 60;
        document.getElementById('current-duration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// Update current trip statistics
function updateCurrentTripStats() {
    document.getElementById('current-distance').textContent = currentTripDistance.toFixed(1);
    
    // Calculate speed (km/h)
    if (currentTripDuration > 0) {
        const speed = (currentTripDistance / currentTripDuration) * 3600;
        document.getElementById('current-speed').textContent = speed.toFixed(1);
    }
    
    // Calculate fuel consumption using user's actual efficiency
    // This will be updated when we get the stats from the backend
    if (window.userEfficiency) {
        currentTripFuel = (currentTripDistance / 100) * window.userEfficiency;
        document.getElementById('current-fuel').textContent = currentTripFuel.toFixed(2);
    }
}

// Save location to backend
function saveLocation(lat, lon, accuracy) {
    fetch("/api/location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            lat: lat, 
            lon: lon, 
            accuracy: accuracy,
            timestamp: new Date().toISOString() 
        })
    })
    .then(res => res.json())
    .then(data => console.log("Location saved:", data))
    .catch(err => console.error("Error saving location:", err));
}

// Save trip data
function saveTripData() {
    const endLocation = path.getLatLngs()[path.getLatLngs().length - 1];
    
    const tripData = {
        start_time: tripStartTime.toISOString(),
        end_time: new Date().toISOString(),
        distance_km: currentTripDistance,
        duration_seconds: currentTripDuration,
        fuel_consumed_liters: currentTripFuel,
        start_location: tripStartLocation,
        end_location: endLocation ? [endLocation.lat, endLocation.lng] : null
    };
    
    // Send trip data to backend
    fetch('/api/trips', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(tripData)
    })
    .then(res => res.json())
    .then(data => {
        console.log("Trip saved:", data);
        // Show success message
        showNotification('{{ _("–ê—è–ª–∞–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞") }}', 'success');
    })
    .catch(err => {
        console.error("Error saving trip:", err);
        showNotification('{{ _("–ê—è–ª–∞–ª —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞") }}', 'error');
    });
}

// Clear path
function clearPath() {
    path.setLatLngs([]);
    currentTripDistance = 0;
    currentTripDuration = 0;
    currentTripFuel = 0;
    updateCurrentTripStats();
}

// Add manual point
function addManualPoint() {
    const lat = parseFloat(document.getElementById('manual-lat').value);
    const lon = parseFloat(document.getElementById('manual-lon').value);
    
    if (isNaN(lat) || isNaN(lon)) {
        alert('{{ _("–ó”©–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –æ—Ä—É—É–ª–Ω–∞ —É—É") }}');
        return;
    }
    
    // Add to path
    path.addLatLng([lat, lon]);
    
    // Move marker
    marker.setLatLng([lat, lon]);
    
    // Center map
    map.setView([lat, lon], 15);
    
    // Clear inputs
    document.getElementById('manual-lat').value = '';
    document.getElementById('manual-lon').value = '';
}

// Load existing path
function loadExistingPath() {
    fetch('/api/location?limit=1000')
        .then(r => r.json())
        .then(points => {
            if (points && points.length) {
                const latlngs = points.map(p => [p.lat, p.lon]);
                path.setLatLngs(latlngs);
                
                if (latlngs.length > 0) {
                    const last = latlngs[latlngs.length - 1];
                    marker.setLatLng(last);
                    map.setView(last, 14);
                }
            }
        })
        .catch(err => console.error("Error loading path:", err));
}

// Refresh overall stats
function refreshOverallStats() {
    fetch('/api/trips/stats')
        .then(r => r.json())
        .then(s => {
            document.getElementById('total-distance').textContent = s.total_distance_km + ' –∫–º';
            document.getElementById('total-moving').textContent = s.moving_time_minutes + ' –º–∏–Ω';
            document.getElementById('total-idle').textContent = s.idle_time_minutes + ' –º–∏–Ω';
            document.getElementById('total-fuel').textContent = s.total_fuel_liters + ' –õ';
            
            // Store user efficiency for current trip calculations
            if (s.efficiency_l_per_100km) {
                window.userEfficiency = s.efficiency_l_per_100km;
                // Update current trip fuel if tracking
                if (isTracking) {
                    updateCurrentTripStats();
                }
            }
        })
        .catch(err => console.error("Error loading stats:", err));
}

// Show notification
function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    
    const bgColor = type === 'success' ? 'bg-green-500' : 
                   type === 'error' ? 'bg-red-500' : 
                   type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
    
    notification.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    container.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadExistingPath();
    refreshOverallStats();
    
    // Set up event listeners
    document.getElementById('start-tracking').addEventListener('click', startTracking);
    document.getElementById('stop-tracking').addEventListener('click', stopTracking);
    document.getElementById('clear-path').addEventListener('click', clearPath);
    document.getElementById('add-manual-point').addEventListener('click', addManualPoint);
    
    // Map type selector
    document.getElementById('map-type').addEventListener('change', function(e) {
        switchMapLayer(e.target.value);
    });
    
    // Refresh stats every 30 seconds
    setInterval(refreshOverallStats, 30000);
    
    // Show welcome message
    setTimeout(() => {
        showNotification('{{ _("–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –±—ç–ª—ç–Ω –±–æ–ª–ª–æ–æ. GPS —Ö—è–Ω–∞–ª—Ç—ã–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç—ç—Ä—Ö —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–Ω–∞ —É—É") }}', 'info');
    }, 1000);
});
</script>
{% endblock %}
